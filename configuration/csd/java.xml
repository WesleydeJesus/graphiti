<?xml version="1.0" encoding="UTF-8"?>
<csd start="Stream">

   <!-- as per http://java.sun.com/javase/6/docs/platform/serialization/spec/protocol.html
   -->

   <choice name="BlockData">
      <reference to="BlockDataShort"/>
      <reference to="BlockDataLong"/>
   </choice>

   <sequence name="BlockDataShort">
      <byte name="tcBlockData" value="0x77"/>
      <byte name="size"/>
      <sequence-of name="Data" size="ancestor::BlockDataShort/size/@value">
         <byte name="byte"/>
      </sequence-of>
   </sequence>

   <sequence name="BlockDataLong">
      <byte name="tcBlockDataLong" value="0x7A"/>
      <int name="size"/>
      <sequence-of name="Data" size="ancestor::BlockDataLong/size/@value">
         <byte name="byte"/>
      </sequence-of>
   </sequence>

   <choice name="ClassAnnotation">
      <byte name="endBlockData" value="0x78"/>
      <sequence name="NonEmptyContents">
         <reference to="Contents"/>
         <byte name="endBlockData" value="0x78"/>
      </sequence>
   </choice>

   <!-- data about the NormalClassDesc in $context -->
   <choice name="ClassData">
      <variable name="flags" select="number($context/ClassDescInfo/classDescFlags/@value)"/>
      <variable name="name" select="string($context/className/@value)"/>
      <reference to="Values" if="$flags eq 2"/>
      <reference to="HashMap" if="$flags eq 3 and $name eq 'java.util.HashMap'"/>
      <error/>
   </choice>

   <choice name="ClassDesc">
      <reference to="NewClassDesc"/>
      <byte name="nullReference" value="0x70"/>
      <reference to="PrevObject"/>
   </choice>

   <sequence name="ClassDescInfo">
      <byte name="classDescFlags"/>
      <reference to="Fields"/>
      <reference to="ClassAnnotation"/>
      <reference to="ClassDesc"/>
   </sequence>

   <sequence-of name="Contents">
      <choice name="Content">
         <reference to="Object"/>
         <reference to="BlockData"/>
      </choice>
   </sequence-of>

   <sequence name="Exception">
      <byte name="tcException" value="0x7B"/>
      <reference name="object" to="UTF8String"/>
   </sequence>

   <sequence name="Fields">
      <short name="count"/>
      <sequence-of name="FieldSequence" size="number(ancestor::Fields/count/@value)">
         <reference to="FieldDesc"/>
      </sequence-of>
   </sequence>

   <choice name="FieldDesc">
      <reference to="PrimitiveDesc"/>
      <reference to="ObjectDesc"/>
   </choice>

   <!-- java.util.HashMap has a readObject function. -->
   <sequence name="HashMap">
      <!-- first we read its field values. -->
      <reference to="Values"/>

      <!-- a short block of 8 bytes -->
      <byte name="ShortBlock" value="0x77"/>
      <byte name="BlockSize" value="8"/>

      <!-- then the number of buckets -->
      <int name="numBuckets"/>

      <!-- the number of mappings a.k.a size -->
      <int name="size"/>

      <sequence-of name="Entries" size="ancestor::HashMap/size/@value">
         <sequence name="Entry">
            <!-- key -->
            <reference to="Object"/>

            <!-- value -->
            <reference to="Object"/>
         </sequence>
      </sequence-of>
   </sequence>

   <sequence name="NewArray">
      <byte name="tcArray" value="0x75"/>
      <reference to="ClassDesc"/>
      <attach-data name="handle" select="$handles"/>
      <variable name="handles" select="$handles + 1"/>
      <int name="size"/>
      <variable name="size" select="number(size/@value)"/>
      <variable name="classType" select="ClassDesc/NewClassDesc/NormalClassDesc/className"/>
      <choice name="ArrayValues">
         <sequence-of name="ByteValues" size="$size" if="$classType/@value = '[B'">
            <reference to="NewByte"/>
         </sequence-of>
         <sequence-of name="CharValues" size="$size" if="$classType/@value = '[C'">
            <reference to="NewChar"/>
         </sequence-of>
         <sequence-of name="DoubleValues" size="$size" if="$classType/@value = '[D'">
            <reference to="NewDouble"/>
         </sequence-of>
         <sequence-of name="FloatValues" size="$size" if="$classType/@value = '[F'">
            <reference to="NewFloat"/>
         </sequence-of>
         <sequence-of name="IntValues" size="$size" if="$classType/@value = '[I'">
            <reference to="NewInt"/>
         </sequence-of>
         <sequence-of name="LongValues" size="$size" if="$classType/@value = '[J'">
            <reference to="NewLong"/>
         </sequence-of>
         <sequence-of name="ShortValues" size="$size" if="$classType/@value = '[S'">
            <reference to="NewShort"/>
         </sequence-of>
         <sequence-of name="BooleanValues" size="$size" if="$classType/@value = '[Z'">
            <reference to="NewBoolean"/>
         </sequence-of>

         <sequence-of name="ObjectValues" size="$size" if="starts-with($classType/@value, '[L')">
            <reference to="Object"/>
         </sequence-of>
      </choice>
   </sequence>

   <boolean name="NewBoolean"/>

   <byte name="NewByte"/>

   <char name="NewChar"/>

   <sequence name="NewClass">
      <byte name="tcClass" value="0x76"/>
      <reference to="ClassDesc"/>
      <attach-data name="handle" select="$handles"/>
      <variable name="handles" select="$handles + 1"/>
   </sequence>

   <choice name="NewClassDesc">
      <sequence name="NormalClassDesc">
         <byte name="tcClassDesc" value="0x72"/>
         <reference name="className" to="UTF8String"/>
         <long name="serialVersionUID"/>
         <attach-data name="handle" select="$handles"/>
         <variable name="handles" select="$handles + 1"/>
         <reference to="ClassDescInfo"/>
      </sequence>

      <sequence name="ProxyClassDesc">
         <byte name="tcProxyClassDesc" value="0x7D"/>
         <attach-data name="handle" select="$handles"/>
         <variable name="handles" select="$handles + 1"/>
         <reference to="ProxyClassDescInfo"/>
      </sequence>
   </choice>

   <double name="NewDouble"/>

   <sequence name="NewEnum">
      <byte name="tcEnum" value="0x7E"/>
      <reference to="ClassDesc"/>
      <attach-data name="handle" select="$handles"/>
      <variable name="handles" select="$handles + 1"/>
      <reference name="enumConstantName" to="UTF8String"/>
   </sequence>

   <float name="NewFloat"/>

   <int name="NewInt"/>

   <long name="NewLong"/>

   <sequence name="NewObject">
      <byte name="tcObject" value="0x73"/>
      <reference to="ClassDesc"/>
      <attach-data name="handle" select="$handles"/>
      <variable name="handles" select="$handles + 1"/>

      <!-- for each class read, from superclass to subclass (hence "reverse") -->
      <for-each name="ClassDataArray" select="reverse((parent::node())/descendant::NormalClassDesc)">
         <reference to="ClassData"/>
      </for-each>
   </sequence>

   <short name="NewShort"/>

   <choice name="NewString">
      <sequence name="NormalString">
         <byte name="tcString" value="0x74"/>
         <attach-data name="handle" select="$handles"/>
         <variable name="handles" select="$handles + 1"/>
         <reference name="value" to="UTF8String"/>
      </sequence>

      <sequence name="LongString">
         <byte name="tcLongString" value="0x7C"/>
         <attach-data name="handle" select="$handles"/>
         <variable name="handles" select="$handles + 1"/>
         <reference name="value" to="LongUTF8String"/>
      </sequence>
   </choice>

   <choice name="Object">
      <reference to="NewArray"/>
      <reference to="NewClass"/>
      <reference to="NewClassDesc"/>
      <reference to="NewEnum"/>
      <reference to="NewObject"/>
      <reference to="NewString"/>
      <reference to="PrevObject"/>
      <byte name="nullReference" value="0x70"/>
      <reference to="Exception"/>
      <byte name="tcReset" value="0x79"/>
   </choice>

   <choice name="ObjectAnnotation">
      <byte name="endBlockData" value="0x78"/>
      <sequence name="NonEmptyContents">
         <reference to="Contents"/>
         <byte name="endBlockData" value="0x78"/>
      </sequence>
   </choice>

   <sequence name="ObjectDesc">
      <reference to="ObjectTypeCode"/>
      <reference name="fieldName" to="UTF8String"/>

      <!-- the specification is utterly unclear at this point...
         Most of the time we WILL find a utf-8 string with a class name.
         But sometimes it is a PrevObject if the class has already been defined. -->
      <reference to="Object"/>
   </sequence>

   <choice name="ObjectTypeCode">
      <byte name="array" value="'['"/>
      <byte name="object" value="'L'"/>
   </choice>

   <sequence name="PrevObject">
      <byte name="tcReference" value="0x71"/>
      <int name="handle"/>
      <variable name="handleValue" select="string(handle/@value)"/>
      <attach-data name="copy" select="(ancestor::Stream)//*[string(./handle/@value) eq $handleValue]"
      />
   </sequence>

   <sequence name="PrimitiveDesc">
      <reference to="PrimitiveTypeCode"/>
      <reference name="fieldName" to="UTF8String"/>
   </sequence>

   <choice name="PrimitiveTypeCode">
      <byte name="byte" value="'B'"/>
      <byte name="char" value="'C'"/>
      <byte name="double" value="'D'"/>
      <byte name="float" value="'F'"/>
      <byte name="integer" value="'I'"/>
      <byte name="long" value="'J'"/>
      <byte name="short" value="'S'"/>
      <byte name="boolean" value="'Z'"/>
   </choice>

   <sequence name="ProxyClassDescInfo">
      <int name="count"/>
      <sequence-of name="ProxyFields" size="number(ancestor::ProxyClassDescInfo/count/@value)">
         <reference name="fieldName" to="UTF8String"/>
      </sequence-of>
      <reference to="ClassAnnotation"/>
      <reference to="ClassDesc"/>
   </sequence>

   <sequence name="Stream">
      <short name="magic" value="0xACED"/>
      <short name="version" value="0x0005"/>
      <!-- create the handles variable, init value: 8257537 = 0x7E0001 -->
      <variable name="handles" select="8257537"/>
      <reference to="Contents"/>
   </sequence>

   <!-- $context = NormalClassDesc -->
   <for-each name="Values" select="$context/ClassDescInfo/Fields/FieldSequence/FieldDesc">
      <!-- $context = FieldDesc -->
      <choice name="FieldValue">
         <reference to="NewByte" if="$context/PrimitiveDesc/PrimitiveTypeCode/byte"/>
         <reference to="NewChar" if="$context/PrimitiveDesc/PrimitiveTypeCode/char"/>
         <reference to="NewDouble" if="$context/PrimitiveDesc/PrimitiveTypeCode/double"/>
         <reference to="NewFloat" if="$context/PrimitiveDesc/PrimitiveTypeCode/float"/>
         <reference to="NewInt" if="$context/PrimitiveDesc/PrimitiveTypeCode/integer"/>
         <reference to="NewLong" if="$context/PrimitiveDesc/PrimitiveTypeCode/long"/>
         <reference to="NewShort" if="$context/PrimitiveDesc/PrimitiveTypeCode/short"/>
         <reference to="NewBoolean" if="$context/PrimitiveDesc/PrimitiveTypeCode/boolean"/>

         <reference to="Object" if="$context/ObjectDesc/ObjectTypeCode/object"/>
         <reference to="NewArray" if="$context/ObjectDesc/ObjectTypeCode/array"/>
      </choice>
   </for-each>

   <sequence name="WRClass">
      <reference to="Values"/>
      <reference to="ObjectAnnotation"/>
   </sequence>

</csd>
