<?xml version="1.0" encoding="UTF-8"?>
<csd>
   
   <!-- as per http://java.sun.com/javase/6/docs/platform/serialization/spec/protocol.html -->

   <sequence name="Stream">
      <short name="magic" value="0xACED"/>
      <short name="version" value="0x0005"/>
      <reference to="Contents"/>
   </sequence>

   <choice name="BlockData">
      <reference to="BlockDataShort"/>
      <reference to="BlockDataLong"/>
   </choice>

   <sequence name="BlockDataShort">
      <byte name="tcBlockData" value="0x77"/>
      <byte name="size"/>
      <sequenceOf name="Data" size="$size">
         <byte/>
      </sequenceOf>
   </sequence>

   <sequence name="BlockDataLong">
      <byte name="tcBlockDataLong" value="0x7A"/>
      <int name="size"/>
      <sequenceOf name="Data" size="$size">
         <byte/>
      </sequenceOf>
   </sequence>

   <choice name="ClassAnnotation">
      <byte name="endBlockData" value="0x78"/>
      <sequence name="NonEmptyContents">
         <reference to="Contents"/>
         <byte name="endBlockData" value="0x78"/>
      </sequence>
   </choice>

   <choice name="ClassData">
      <variable name="flags" select="$context/ClassDescInfo/classDescFlags/@value"/>
      <reference to="Values" if="$flags eq '2'"/>
      <reference to="WRClass" if="$flags eq '3'"/>
      <error/>
   </choice>

   <choice name="ClassDesc">
      <reference to="NewClassDesc"/>
      <byte name="nullReference" value="0x70"/>
      <reference to="PrevObject"/>
   </choice>

   <sequence name="ClassDescInfo">
      <byte name="classDescFlags"/>
      <reference to="Fields"/>
      <reference to="ClassAnnotation"/>
      <reference to="ClassDesc"/>
   </sequence>

   <choice name="Content">
      <reference to="Object"/>
      <reference to="BlockData"/>
   </choice>

   <sequenceOf name="Contents">
      <reference to="Content"/>
   </sequenceOf>

   <sequence name="Exception">
      <byte name="tcException" value="0x7B"/>
      <reference name="object" to="UTF8String"/>
   </sequence>

   <sequence name="Fields">
      <short name="count"/>
      <sequenceOf name="FieldSequence" size="ancestor::Fields/count/@value">
         <reference to="FieldDesc"/>
      </sequenceOf>
   </sequence>

   <choice name="FieldDesc">
      <reference to="PrimitiveDesc"/>
      <reference to="ObjectDesc"/>
   </choice>

   <sequence name="NewArray">
      <byte name="tcArray" value="0x75"/>
      <reference to="ClassDesc"/>
      <int name="size"/>
   </sequence>

   <sequence name="NewClass">
      <byte name="tcClass" value="0x76"/>
      <reference to="ClassDesc"/>
   </sequence>

   <choice name="NewClassDesc">
      <sequence name="NormalClassDesc">
         <byte name="tcClassDesc" value="0x72"/>
         <reference name="className" to="UTF8String"/>
         <long name="serialVersionUID"/>
         <reference to="ClassDescInfo"/>
      </sequence>

      <sequence name="ProxyClassDesc">
         <byte name="tcProxyClassDesc" value="0x7D"/>
         <reference to="ProxyClassDescInfo"/>
      </sequence>
   </choice>

   <sequence name="NewEnum">
      <byte name="tcEnum" value="0x7E"/>
      <reference to="ClassDesc"/>
      <reference name="enumConstantName" to="UTF8String"/>
   </sequence>

   <sequence name="NewObject">
      <byte name="tcObject" value="0x73"/>
      <reference to="ClassDesc"/>
      <forEach name="ClassDataArray" select="(parent::node())/descendant::NormalClassDesc">
         <reference to="ClassData"/>
      </forEach>
   </sequence>

   <choice name="NewString">
      <sequence name="NormalString">
         <byte name="tcString" value="0x74"/>
         <reference name="value" to="UTF8String"/>
      </sequence>

      <sequence name="LongString">
         <byte name="tcLongString" value="0x7C"/>
         <reference name="value" to="LongUTF8String"/>
      </sequence>
   </choice>

   <choice name="Object">
      <reference to="NewArray"/>
      <reference to="NewClass"/>
      <reference to="NewClassDesc"/>
      <reference to="NewEnum"/>
      <reference to="NewObject"/>
      <reference to="NewString"/>
      <reference to="PrevObject"/>
      <byte name="nullReference" value="0x70"/>
      <reference to="Exception"/>
      <byte name="tcReset" value="0x79"/>
   </choice>
   
   <choice name="ObjectAnnotation">
      <byte name="endBlockData" value="0x78"/>
      <sequence name="NonEmptyContents">
         <reference to="Contents"/>
         <byte name="endBlockData" value="0x78"/>
      </sequence>
   </choice>

   <sequence name="ObjectDesc">
      <reference to="ObjectTypeCode"/>
      <reference name="fieldName" to="UTF8String"/>
      <reference name="className" to="UTF8String"/>
   </sequence>

   <choice name="ObjectTypeCode">
      <char value="["/>
      <char value="L"/>
   </choice>

   <sequence name="PrevObject">
      <byte name="tcReference" value="0x71"/>
      <int name="handle"/>
   </sequence>

   <sequence name="PrimitiveDesc">
      <reference to="PrimitiveTypeCode"/>
      <reference name="fieldName" to="UTF8String"/>
   </sequence>

   <choice name="PrimitiveTypeCode">
      <char name="byte" value="B"/>
      <char name="char" value="C"/>
      <char name="double" value="D"/>
      <char name="float" value="F"/>
      <char name="integer" value="I"/>
      <char name="long" value="J"/>
      <char name="short" value="S"/>
      <char name="boolean" value="Z"/>
   </choice>

   <sequence name="ProxyClassDescInfo">
      <int name="count"/>
      <sequenceOf name="ProxyFields" size="$count">
         <reference name="fieldName" to="UTF8String"/>
      </sequenceOf>
      <reference to="ClassAnnotation"/>
      <reference to="ClassDesc"/>
   </sequence>
   
   <sequence name="Values">
      <forEach name="FieldArray" select="$context/ClassDescInfo/Fields/FieldSequence/FieldDesc">
         <choice name="FieldValue">
            <int name="float" if="$context/PrimitiveDesc/PrimitiveTypeCode/float"/>
            <int name="int" if="$context/PrimitiveDesc/PrimitiveTypeCode/integer"/>
         </choice>
      </forEach>
   </sequence>
   
   <sequence name="WRClass">
      <reference to="Values"/>
      <reference to="ObjectAnnotation"/>
   </sequence>

</csd>
